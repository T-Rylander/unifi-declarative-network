# UniFi Network 9.5.21 + USG-3P Notes

**CURRENT CONFIGURATION BASELINE: rylan-dc-acl-segmented-2025-11-29.unf**  
All instructions and diagrams in this document now reflect the L3-ACL-based architecture deployed 29 Nov 2025.

These operational notes make the repo safe for 9.5.21 with USG-3P.

## Mandatory UI Step Before Script
- After adopting the USG-3P, immediately change the Default LAN to `10.0.1.0/27` in the controller UI.
- Do this before creating any VLANs. Managing VLAN 1 via API/config is error-prone and can break adoption.

## Configuration Rules
- VLAN 1 must not appear in `config/vlans.yaml`.
- The script keeps skip logic for `vlan_id == 1` and will not modify VLAN 1 unless explicit migration flags are used.
- The legacy bootstrap network must not use `vlan_id: 1`.

## Rationale
- UniFi 9.5.21 + USG-3P is sensitive to changes on the Default LAN during initial adoption.
- Setting `10.0.1.0/27` early ensures devices re-adopt cleanly and VLAN creation applies reliably.

## Sequence That Works
1. Factory reset all devices (default 192.168.1.0/24)
2. Fresh controller; complete wizard with a local admin (skip Ubiquiti login → no 2FA)
3. Adopt USG-3P first
4. Change Default LAN to `10.0.1.0/27` in UI (mandatory)
5. Adopt switches/APs
6. Run the script

### ⚠️ DEPRECATED – Firewall → LAN IN Rules (pre Nov 29 2025)
The classic LAN IN firewall ruleset has been superseded by switch-level L3 ACLs + Network Isolation.  
All previous LAN IN tables and JSON snippets in this document are kept for historical reference only and are no longer applied.

### Current Segmentation Truth – Switch L3 ACLs + Network Isolation
(November 29 2025 – fully operational and backed up as rylan-dc-acl-segmented-2025-11-29.unf)

| Priority | Name                  | Type       | Action   | Protocol | Source Network     | Destination Network           | Ports       | Purpose / Notes |
|----------|-----------------------|------------|----------|----------|--------------------|-------------------------------|-------------|---------------------------------|
| +3       | NAT Outbound          | Masquerade | Allow    | All      | All VLANs          | Internet (WAN1)               | —           | Internet access for every device |
| +2       | Trusted → Most        | IPv4 ACL   | Allow    | All      | trusted-devices (30) | servers (10), voip (40)     | Any         | Workstations reach infra & phones |
| +2       | Servers → Most        | IPv4 ACL   | Allow    | All      | servers (10)       | trusted-devices (30), voip (40) | Any      | Infra reaches workstations & phones |
| +1       | VoIP → Servers        | IPv4 ACL   | Allow    | UDP      | voip (40)          | servers (10)                  | Any UDP     | Phone registration, LDAP, DNS to AD |
| Implicit | All other inter-VLAN  | —          | Drop     | —        | —                  | —                             | —           | Guest/IoT (90) and anything not explicitly allowed is blocked |

Management VLAN 1 (10.0.1.0/27) is intentionally excluded from L3 Isolation and retains full bidirectional access (required for UniFi adoption and controller operation).

### Where to make future granular changes
• Intra-VLAN control (inside the same VLAN) → use classic Settings → Security → Firewall & Security → LAN LOCAL or LAN IN rules  
• Internet-bound traffic shaping / application blocking → use Settings → Traffic & Security → Traffic Rules or Internet Threat Management  
• Any new inter-VLAN exception → add a new IPv4 ACL row in Settings → Networks → Policy Table (the table above is the single source of truth)
